<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import {
  getFirestore, collection, addDoc, getDocs,
  updateDoc, deleteDoc, doc
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDQvA6XiiwiyMrh0xjdy5s4QNjXwIgQoh4",
  authDomain: "agendamovom.firebaseapp.com",
  projectId: "agendamovom",
  storageBucket: "agendamovom.firebasestorage.app",
  messagingSenderId: "919577291328",
  appId: "1:919577291328:web:65f5937da45903598ccda5"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

document.addEventListener("DOMContentLoaded", () => {

  const tabela = document.getElementById("tabela");
  const vencidas = document.getElementById("vencidas");

  function calcReavaliacao(data) {
      if (!data) return "";
      const d = new Date(data);
      d.setMonth(d.getMonth() + 3);
      return d.toISOString().split("T")[0];
  }

  function criarLinha(id, d) {
      const tr = document.createElement("tr");

      tr.innerHTML = `
<td><input value="${d.nome || ""}"></td>
<td>
  <select>
    <option ${d.tipo==="Avalia√ß√£o"?"selected":""}>Avalia√ß√£o</option>
    <option ${d.tipo==="Aula"?"selected":""}>Aula</option>
  </select>
</td>
<td><input type="date" value="${d.dataAvaliacao || ""}"></td>
<td><input type="date" value="${d.dataReavaliacao || ""}" readonly></td>
<td>
  <select>
    <option ${d.plano==="Gympass"?"selected":""}>Gympass</option>
    <option ${d.plano==="Totalpass"?"selected":""}>Totalpass</option>
    <option ${d.plano==="Mensal"?"selected":""}>Mensal</option>
  </select>
</td>
<td><button class="btn-del">üóëÔ∏è</button></td>
`;

      const inputs = tr.querySelectorAll("input, select");

      tr.addEventListener("change", async () => {
          const dados = {
              nome: inputs[0].value,
              tipo: inputs[1].value,
              dataAvaliacao: inputs[2].value,
              dataReavaliacao: calcReavaliacao(inputs[2].value),
              plano: inputs[4].value
          };
          inputs[3].value = dados.dataReavaliacao;
          await updateDoc(doc(db, "alunos", id), dados);
          atualizarVencidas();
      });

      tr.querySelector(".btn-del").onclick = async () => {
          if (confirm("Apagar este registro?")) {
              await deleteDoc(doc(db, "alunos", id));
              tr.remove();
              atualizarVencidas();
          }
      };

      tabela.appendChild(tr);
  }

  async function carregar() {
      tabela.innerHTML = "";
      const snap = await getDocs(collection(db, "alunos"));
      snap.forEach(s => criarLinha(s.id, s.data()));
      atualizarVencidas();
  }

  async function atualizarVencidas() {
      vencidas.innerHTML = "";
      const hoje = new Date();
      const snap = await getDocs(collection(db, "alunos"));

      snap.forEach(s => {
          const d = s.data();
          if (d.dataReavaliacao && new Date(d.dataReavaliacao) < hoje) {
              vencidas.innerHTML += `
<tr class="vencida">
<td>${d.nome}</td>
<td>${d.dataAvaliacao}</td>
<td>${d.dataReavaliacao}</td>
<td>${d.plano}</td>
</tr>`;
          }
      });
  }

  // üëá EXP√ïE A FUN√á√ÉO PARA O BOT√ÉO
  window.adicionar = async () => {
      const ref = await addDoc(collection(db, "alunos"), {
          nome: "",
          tipo: "Avalia√ß√£o",
          dataAvaliacao: "",
          dataReavaliacao: "",
          plano: "Mensal"
      });

      criarLinha(ref.id, {
          nome: "",
          tipo: "Avalia√ß√£o",
          dataAvaliacao: "",
          dataReavaliacao: "",
          plano: "Mensal"
      });
  };

  carregar();
});
</script>

